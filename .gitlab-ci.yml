image: docker:stable-dind

variables:
  DOCKER_HOST: tcp://docker:2376
  DOCKER_TLS_VERIFY: 1
  DOCKER_CERT_PATH: /certs/client
  http_proxy: $PROXY
  https_proxy: $PROXY
  no_proxy: $NOPROXY
  
before_script:
  - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY || true

docker-build:
  stage: build
  script:
    - export IMAGE=$CI_REGISTRY_IMAGE:$(date +%Y%m%d%H%M%S)
    - export LATEST=$CI_REGISTRY_IMAGE:latest
    - docker build --build-arg http_proxy=$http_proxy --build-arg https_proxy=$https_proxy --build-arg no_proxy=$no_proxy -t "$IMAGE" .
    - docker push "$IMAGE"
    - docker tag "$IMAGE" "$LATEST"
    - docker push "$LATEST"
